pipeline {
    agent {
        label 'dev-server'
    }

    parameters {
        choice choices: ['dev', 'prod'], name: 'Select_environment'
    }

    environment {
        NAME = "Sreekanth"
    }

    tools {
        maven 'MAVEN_HOME'
    }

    options {
        skipStagesAfterUnstable()
    }

    stages {
        stage('Build') {
            steps {
                bat 'mvn -B -DskipTests clean package'
            }
        }

        stage('Test') {
            parallel {
                stage('Test A') {
                    steps {
                        echo 'This is Test A'
                        bat 'mvn test'
                    }
                }
                stage('Test B') {
                    steps {
                        echo 'This is Test B'
                        bat 'mvn test'
                    }
                }
            }
            post {
                success {
                    dir('target/surefire-reports') {
                        junit '**/TEST-*.xml'
                    }
                }
            }
        }

        stage('Deploy') {
            when {
                expression { params.Select_environment == 'prod' }
            }
            steps {
                echo "Deploying to Apache on Windows"

                bat '''
                net stop Apache2.4 || exit 0
                xcopy target\\* C:\\Apache24\\htdocs /E /Y
                net start Apache2.4
                '''
            }
        }
    }
}
